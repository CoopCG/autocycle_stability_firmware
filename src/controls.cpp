//
// Created by Cooper Grill on 4/7/2020.
//

double integral=0;
double params[][]={{33.69352243, 0.263932, 21.15690148}, {101.20843419, 4.4401922, 38.1772637},
                 {102.20843419, 5.4401922, 37.55922972}, {103.20843419, 5.8221582, 35.94119572},
                 {102.97236622, 5.96805622, 34.32316172}, {103.97236622, 6.35002222, 32.70512772},
                 {104.97236622, 6.49592025, 32.08709375}, {104.35433225, 6.18809353, 27.85102572},
                 {105.35433225, 7.18809353, 27.23299175}, {105.25222667, 7.33399156, 26.61495777},
                 {105.63419267, 7.21653726, 25.9969238}, {104.61175785, 7.09906907, 25.37888982},
                 {105.35554416, 7.62693309, 19.40675385}, {103.73751016, 8.00889909, 17.78871985},
                 {104.73751016, 8.39086509, 17.17068588}, {104.47474016, 8.77283109, 16.5526519},
                 {105.47474016, 8.15479712, 15.93461793}, {102.25887179, 8.53676312, 14.31658393},
                 {101.64083781, 8.91872912, 13.69854995}, {102.64083781, 9.30069512, 12.08051595},
                 {102.02280384, 8.68266114, 11.46248198}, {103.02280384, 9.68266114, 9.84444798},
                 {104.02280384, 10.68266114, 9.226414}};

double min(double a, double b) {
    return(a>b ? b:a);
}

double max(double a, double b) {
    return(a>b ? a:b);
}

double get_torque(float dt, double *e, float v, double max_torque) {
    integral+=e[0]*dt;

    int index=(int)((v-4)/0.5);
    float interpolation=(v-4-index*0.5)/0.5;

    double k_p=params[index][0]+interpolation*(params[index+1][0]-params[index][0]);
    double k_i=params[index][1]+interpolation*(params[index+1][1]-params[index][1]);
    double k_d=params[index][2]+interpolation*(params[index+1][2]-params[index][2]);
    return(min(max_torque, max(-max_torque, k_p*e[0]+k_d*e[2]+k_i*integral)));
}